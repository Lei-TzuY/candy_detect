<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雙鏡頭錄影系統</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveBackground 60s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes moveBackground {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-50px, -50px);
            }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .global-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .global-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .global-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .global-btn.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
        }

        .timer {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
        }

        .camera-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .camera-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .camera-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6b7280;
        }

        .status-dot.active {
            background: #10b981;
            animation: blink 1s infinite;
        }

        .status-dot.recording {
            background: #ef4444;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .video-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        /* 縮放狀態 */
        .video-container.zoomed {
            cursor: zoom-out;
        }

        .video-container.zoomed img {
            transform: scale(2);
            cursor: move;
        }

        .video-container.zoomed {
            overflow: hidden;
        }

        /* 全螢幕模式 */
        .video-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
            margin: 0;
            aspect-ratio: unset;
        }

        .video-container.fullscreen img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #6b7280;
        }

        /* 視頻控制工具列 */
        .video-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        /* 縮放提示 */
        .zoom-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease, background 0.3s ease;
            z-index: 10;
            pointer-events: none;
        }

        .video-container.fullscreen .zoom-indicator {
            opacity: 1;
        }

        .video-container.zoomed .zoom-indicator {
            opacity: 1;
            background: rgba(16, 185, 129, 0.7);
        }

        .video-container:hover .video-controls {
            opacity: 1;
        }

        .video-container.fullscreen .video-controls {
            opacity: 1;
        }

        .video-control-btn {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }

        .video-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .video-control-btn:active {
            transform: scale(0.95);
        }

        .video-control-btn.active {
            background: rgba(16, 185, 129, 0.8);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn.active {
            background: #10b981;
        }

        .focus-control {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .focus-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .focus-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.3);
            -webkit-appearance: none;
            appearance: none;
        }

        .focus-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .focus-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .focus-slider::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        /* 對焦狀態提示動畫 */
        [id^="focus-status-"] {
            transition: opacity 0.3s ease, color 0.3s ease;
        }

        .recordings-section {
            margin-top: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .recordings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .recordings-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .recording-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .recording-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .recording-name {
            font-weight: 600;
        }

        .recording-meta {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .recording-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .action-btn.delete {
            background: rgba(239, 68, 68, 0.3);
        }

        .action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.5);
        }

        /* 教學指南樣式 */
        .guide-section {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .guide-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .guide-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .guide-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .guide-content {
            margin-top: 20px;
            display: none;
        }

        .guide-content.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .guide-steps {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .guide-step {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #10b981;
        }

        .step-number {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: 700;
            margin-right: 12px;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .step-description {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-left: 44px;
        }

        .step-tips {
            background: rgba(59, 130, 246, 0.2);
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 10px;
            margin-left: 44px;
            border-left: 3px solid #3b82f6;
        }

        .step-tips-title {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 5px;
        }

        .guide-important {
            background: rgba(245, 158, 11, 0.2);
            padding: 15px 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #f59e0b;
        }

        .guide-important-title {
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checklist {
            list-style: none;
            margin-top: 15px;
            margin-left: 44px;
        }

        .checklist li {
            padding: 8px 0;
            position: relative;
            padding-left: 30px;
        }

        .checklist li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: 700;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .cameras-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .global-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🎥 雙鏡頭錄影系統</h1>
            <div class="nav-buttons">
                <a href="/" class="nav-btn">🏠 返回首頁</a>
                <a href="/annotate" class="nav-btn">🏷️ 標註模式</a>
                <a href="/trainer" class="nav-btn">🤖 訓練模式</a>
                <button class="nav-btn" onclick="restartApp()" title="重啟應用程式">🔄</button>
            </div>
        </div>

        <!-- 訓練樣本收集教學指南 -->
        <div class="guide-section">
            <div class="guide-header" onclick="toggleGuide()">
                <h2>📚 訓練樣本收集完整指南</h2>
                <button class="guide-toggle" id="guide-toggle-btn">
                    展開教學 ▼
                </button>
            </div>
            <div class="guide-content" id="guide-content">
                <div class="guide-steps">
                    <div class="guide-step">
                        <div class="step-title">
                            <span class="step-number">1</span>
                            準備拍攝環境
                        </div>
                        <div class="step-description">
                            確保拍攝環境光線充足且穩定，鏡頭對準產品生產線或檢測區域。建議使用固定架或三腳架以保持鏡頭穩定，避免晃動影響後續標註與訓練效果。
                        </div>
                        <div class="step-tips">
                            <div class="step-tips-title">💡 環境建議：</div>
                            <ul class="checklist">
                                <li>使用均勻的白光或自然光，避免強烈陰影</li>
                                <li>確保背景簡潔，減少干擾物體</li>
                                <li>保持拍攝角度與實際檢測時一致</li>
                            </ul>
                        </div>
                    </div>

                    <div class="guide-step">
                        <div class="step-title">
                            <span class="step-number">2</span>
                            開始預覽與調整焦距
                        </div>
                        <div class="step-description">
                            點擊「全部開始預覽」按鈕啟動雙鏡頭即時畫面。使用下方的「手動對焦」滑桿調整每個鏡頭的焦距，確保產品細節清晰可見。良好的對焦是高品質樣本的基礎。
                        </div>
                        <div class="step-tips">
                            <div class="step-tips-title">🎯 對焦技巧：</div>
                            <ul class="checklist">
                                <li>在預覽模式下即時調整對焦滑桿（0-255）</li>
                                <li><strong>使用 ±1 和 ±10 按鈕微調對焦值</strong></li>
                                <li>觀察產品邊緣是否清晰銳利</li>
                                <li>可針對不同鏡頭個別調整至最佳狀態</li>
                                <li><strong>使用 🔍 縮放按鈕放大檢視細節</strong></li>
                                <li><strong>使用 ⛶ 全螢幕按鈕全屏查看（或按 F 鍵）</strong></li>
                                <li>💡 提示：畫面左上角顯示當前解析度，確保為 1280x720 或更高</li>
                            </ul>
                        </div>
                    </div>

                    <div class="guide-step">
                        <div class="step-title">
                            <span class="step-number">3</span>
                            錄製多樣化訓練影片
                        </div>
                        <div class="step-description">
                            點擊「全部開始錄影」開始同步錄製雙鏡頭畫面。錄製時應涵蓋各種場景變化，包括正常產品、不良品、不同光線、不同角度等。建議每個場景錄製 30 秒至 2 分鐘。
                        </div>
                        <div class="step-tips">
                            <div class="step-tips-title">📹 錄製建議：</div>
                            <ul class="checklist">
                                <li>錄製<strong>正常產品</strong>樣本（至少 100 張影格）</li>
                                <li>錄製<strong>瑕疵/不良品</strong>樣本（每種瑕疵至少 50 張）</li>
                                <li>錄製不同光線條件下的畫面</li>
                                <li>錄製產品在不同位置、角度的畫面</li>
                                <li>每段錄影檔案建議 1-3 分鐘，便於後續管理</li>
                            </ul>
                        </div>
                    </div>

                    <div class="guide-step">
                        <div class="step-title">
                            <span class="step-number">4</span>
                            管理錄影檔案
                        </div>
                        <div class="step-description">
                            錄製完成的影片會自動儲存至 <code>recordings/</code> 資料夾。您可以在頁面下方的「📁 錄影檔案」區域查看所有錄影，並下載或刪除不需要的檔案。
                        </div>
                        <div class="step-tips">
                            <div class="step-tips-title">🗂️ 檔案管理：</div>
                            <ul class="checklist">
                                <li>錄影檔案命名格式：camera_N_YYYYMMDD_HHMMSS.avi</li>
                                <li>建議為每種場景錄製獨立的檔案</li>
                                <li>定期檢查並刪除錄製失敗或品質不佳的檔案</li>
                                <li>確保有足夠的儲存空間（建議至少 10GB）</li>
                            </ul>
                        </div>
                    </div>

                    <div class="guide-step">
                        <div class="step-title">
                            <span class="step-number">5</span>
                            後續步驟：標註與訓練
                        </div>
                        <div class="step-description">
                            收集完影片後，需要從影片中提取影格並進行標註。使用 LabelImg、CVAT 或 Roboflow 等標註工具標記產品位置與類別。完成標註後，將資料集放入
                            <code>datasets/candy/</code> 資料夾，即可前往「🤖 訓練模式」頁面開始訓練模型。
                        </div>
                        <div class="step-tips">
                            <div class="step-tips-title">🏷️ 標註要點：</div>
                            <ul class="checklist">
                                <li>每隔 5-10 影格提取一張圖片進行標註</li>
                                <li>標註框應緊貼產品邊緣，不要過大或過小</li>
                                <li>確保每個類別至少有 200 張標註樣本</li>
                                <li>標註格式需為 YOLO 格式（.txt 檔案）</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="guide-important" style="background: rgba(59, 130, 246, 0.2); border-left-color: #3b82f6;">
                    <div class="guide-important-title" style="color: #60a5fa;">
                        🖥️ 檢視功能快捷鍵
                    </div>
                    <ul class="checklist" style="margin-left: 0;">
                        <li><strong>🔍 縮放模式：</strong>點擊畫面或點擊右上角 🔍 按鈕（按 Z 鍵）</li>
                        <li><strong>🖱️ 拖動平移：</strong>縮放後直接拖動畫面查看不同區域</li>
                        <li><strong>⛶ 全螢幕：</strong>點擊右上角 ⛶ 按鈕（按 F 鍵）</li>
                        <li><strong>🎡 滾輪縮放：</strong>全螢幕模式下使用滑鼠滾輪縮放（1x-5x）</li>
                        <li><strong>⎋ 快速退出：</strong>按 ESC 鍵退出全螢幕或縮放模式</li>
                    </ul>
                </div>

                <div class="guide-important">
                    <div class="guide-important-title">
                        ⚠️ 重要提醒
                    </div>
                    <ul class="checklist" style="margin-left: 0;">
                        <li>樣本數量直接影響模型準確度，建議每個類別至少 200-500 張圖片</li>
                        <li>樣本多樣性越高（不同光線、角度、背景），模型越穩健</li>
                        <li>確保正常品與不良品樣本數量平衡，避免模型偏向某一類</li>
                        <li>錄影時保持鏡頭穩定，避免過度晃動導致影像模糊</li>
                        <li>定期備份錄影檔案與標註資料，防止資料遺失</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="global-controls">
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                <label style="font-weight: 600; font-size: 0.9rem;">
                    📹 視頻編碼器：
                    <select id="codec-selector"
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 8px 12px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-left: 8px;">
                        <option value="avc1" style="background: #4a5568; color: white;">H.264 (avc1) - 推薦</option>
                        <option value="XVID" style="background: #4a5568; color: white;" selected>XVID - 高相容</option>
                        <option value="MJPG" style="background: #4a5568; color: white;">MJPG - 通用</option>
                        <option value="mp4v" style="background: #4a5568; color: white;">mp4v - 備用</option>
                    </select>
                </label>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7); text-align: center;">
                    H.264最佳畫質 | XVID最廣泛支援 | MJPG最高相容
                </div>
            </div>
            <button class="global-btn" id="btn-preview-all" onclick="toggleAllPreview()">
                👁️ 全部開始預覽
            </button>
            <button class="global-btn" id="btn-record-all" onclick="toggleAllRecording()">
                ⏺️ 全部開始錄影
            </button>
            <button class="global-btn" style="background: linear-gradient(135deg, #10b981, #059669);"
                onclick="extractFramesNow()">
                📸 擷取圖像
            </button>
            <button class="global-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626);"
                onclick="forceStopAllRecording()">
                🛑 強制停止所有錄影
            </button>
            <button class="global-btn" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);"
                onclick="checkRecordingStatus()">
                🔍 檢查狀態
            </button>
            <div class="timer" id="global-timer">00:00:00</div>
        </div>

        <!-- 攝影機選擇器 -->
        <div
            style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; margin-bottom: 30px;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="display: flex; gap: 10px; align-items: center; flex: 1;">
                    <label style="font-weight: 600;">選擇攝影機：</label>
                    <select id="camera-selector"
                        style="flex: 1; max-width: 200px; padding: 10px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-weight: 600; cursor: pointer;">
                        <option value="" style="background: #333; color: white;">-- 選擇 --</option>
                    </select>
                    <button id="btn-add-camera" class="nav-btn" style="padding: 10px 20px;">
                        ➕ 新增鏡頭
                    </button>
                    <button id="btn-detect-cameras" class="nav-btn" style="padding: 10px 20px;">
                        🔍 偵測攝影機
                    </button>
                </div>
                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                    💡 請先選擇並新增攝影機
                </div>
            </div>
        </div>

        <div class="cameras-grid" id="cameras-grid">
            <!-- 動態生成攝影機卡片 -->
        </div>

        <div class="recordings-section">
            <div class="recordings-header">
                <h2>📁 錄影檔案</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="control-btn" id="select-all-recordings-btn" onclick="toggleSelectAllRecordings()"
                        style="display: none;">
                        ☐ 全選
                    </button>
                    <button class="control-btn" id="batch-extract-btn" onclick="batchExtractFrames()"
                        style="display: none; background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                        📷 批量擷取圖像
                    </button>
                    <button class="control-btn" id="batch-delete-recordings-btn" onclick="batchDeleteRecordings()"
                        style="display: none; background: rgba(239, 68, 68, 0.3);">
                        🗑️ 刪除選中
                    </button>
                    <button class="control-btn" onclick="loadRecordings()">🔄 重新整理</button>
                </div>
            </div>
            <div class="recordings-list" id="recordings-list">
                <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">
                    載入中...
                </div>
            </div>
        </div>
    </div>

    <script>
        // 狀態管理 - 動態管理
        const cameraState = {};
        const activeCameras = new Set(); // 追蹤已新增的攝影機

        let globalRecording = false;
        let timerInterval = null;
        let recordingStartTime = null;

        // 保存使用中的攝影機到 localStorage
        function saveActiveCameras() {
            const cameras = Array.from(activeCameras);
            localStorage.setItem('recorder_active_cameras', JSON.stringify(cameras));
            console.log('已保存攝影機配置:', cameras);
        }

        // 從 localStorage 載入上次使用的攝影機
        function loadActiveCameras() {
            try {
                const saved = localStorage.getItem('recorder_active_cameras');
                if (saved) {
                    const cameras = JSON.parse(saved);
                    console.log('載入上次使用的攝影機:', cameras);
                    return cameras;
                }
            } catch (e) {
                console.error('載入攝影機配置失敗:', e);
            }
            return [];
        }

        // 初始化時偵測攝影機
        window.addEventListener('DOMContentLoaded', function () {
            console.log('頁面已載入，開始偵測攝影機...');

            // 綁定選擇器變更事件 - 選擇後自動新增並預覽
            document.getElementById('camera-selector').addEventListener('change', function () {
                const cameraIndex = parseInt(this.value);
                if (!isNaN(cameraIndex)) {
                    console.log(`選擇了攝影機 ${cameraIndex}，自動新增並開始預覽`);

                    // 如果已經新增過，直接開始預覽
                    if (activeCameras.has(cameraIndex)) {
                        const state = cameraState[cameraIndex];
                        if (!state.previewing) {
                            togglePreview(cameraIndex);
                        }
                        // 重置選擇器
                        this.value = '';
                    } else {
                        // 新增攝影機
                        addCameraCard(cameraIndex);
                        activeCameras.add(cameraIndex);

                        // 初始化狀態
                        cameraState[cameraIndex] = {
                            previewing: false,
                            recording: false,
                            zoomed: false,
                            fullscreen: false
                        };

                        // 延遲一下確保卡片已生成，然後自動開始預覽
                        setTimeout(() => {
                            togglePreview(cameraIndex);
                        }, 100);

                        // 保存配置
                        saveActiveCameras();

                        // 重置選擇器，讓用戶可以繼續選其他攝影機
                        this.value = '';
                    }
                }
            });

            // 綁定按鈕事件
            document.getElementById('btn-add-camera').addEventListener('click', function () {
                console.log('新增鏡頭按鈕被點擊');
                addSelectedCamera();
            });

            document.getElementById('btn-detect-cameras').addEventListener('click', function () {
                console.log('偵測攝影機按鈕被點擊');
                detectCameras();
            });

            detectCameras();
            loadRecordings();
            
            // 自動還原上次使用的攝影機
            setTimeout(() => {
                const savedCameras = loadActiveCameras();
                if (savedCameras.length > 0) {
                    console.log(`正在還原 ${savedCameras.length} 個攝影機...`);
                    savedCameras.forEach((cameraIndex, idx) => {
                        setTimeout(() => {
                            // 新增攝影機卡片
                            addCameraCard(cameraIndex);
                            activeCameras.add(cameraIndex);
                            
                            // 初始化狀態
                            cameraState[cameraIndex] = { 
                                previewing: false, 
                                recording: false, 
                                zoomed: false, 
                                fullscreen: false 
                            };
                            
                            // 自動開始預覽
                            setTimeout(() => {
                                togglePreview(cameraIndex);
                            }, 200);
                        }, idx * 300); // 間隔開啟，避免同時開啟太多攝影機
                    });
                }
            }, 1000); // 等待偵測完成後再還原
        });

        // 偵測可用攝影機
        function detectCameras() {
            console.log('正在偵測攝影機...');
            fetch('/api/cameras/detect')
                .then(res => {
                    console.log('API 回應狀態:', res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('偵測到的攝影機:', data);
                    const selector = document.getElementById('camera-selector');
                    selector.innerHTML = '<option value="" style="background: #333; color: white;">-- 選擇 --</option>';

                    if (data.available && data.available.length > 0) {
                        console.log(`找到 ${data.available.length} 個攝影機`);
                        data.available.forEach(cam => {
                            const option = document.createElement('option');
                            option.value = cam.index;
                            option.textContent = `攝影機 ${cam.index}${cam.in_use ? ' (使用中)' : ''}`;
                            option.style.background = '#333';
                            option.style.color = 'white';
                            selector.appendChild(option);
                        });
                    } else {
                        console.warn('未偵測到可用的攝影機');
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "未找到攝影機";
                        option.style.background = '#333';
                        option.style.color = 'white';
                        selector.appendChild(option);
                    }
                })
                .catch(err => {
                    console.error('偵測攝影機失敗:', err);
                    alert('偵測攝影機失敗: ' + err.message);
                });
        }

        // 新增選中的攝影機
        function addSelectedCamera() {
            console.log('=== 新增攝影機 ===');
            const selector = document.getElementById('camera-selector');
            console.log('selector:', selector);
            console.log('selected value:', selector.value);

            const cameraIndex = parseInt(selector.value);
            console.log('cameraIndex:', cameraIndex);

            if (isNaN(cameraIndex)) {
                alert('請先選擇攝影機');
                return;
            }

            if (activeCameras.has(cameraIndex)) {
                alert(`攝影機 ${cameraIndex} 已經新增`);
                return;
            }

            console.log('準備新增攝影機卡片:', cameraIndex);
            // 新增攝影機卡片
            addCameraCard(cameraIndex);
            activeCameras.add(cameraIndex);

            // 初始化狀態
            cameraState[cameraIndex] = {
                previewing: false,
                recording: false,
                zoomed: false,
                fullscreen: false
            };
            console.log('攝影機卡片已新增');
        }

        // 動態生成攝影機卡片
        function addCameraCard(cameraIndex) {
            const grid = document.getElementById('cameras-grid');
            const card = document.createElement('div');
            card.className = 'camera-card';
            card.setAttribute('data-camera', cameraIndex);
            card.innerHTML = `
                <div class="camera-header">
                    <div class="camera-title">📷 鏡頭 ${cameraIndex}</div>
                    <div class="camera-status">
                        <span class="status-dot" id="status-${cameraIndex}"></span>
                        <span id="status-text-${cameraIndex}">待機中</span>
                    </div>
                    <button onclick="removeCamera(${cameraIndex})" style="background: rgba(239, 68, 68, 0.3); border: none; padding: 6px 12px; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                        🗑️ 移除
                    </button>
                </div>
                <div class="video-container" id="video-container-${cameraIndex}" onclick="toggleZoom(${cameraIndex}, event)">
                    <div class="video-controls">
                        <button class="video-control-btn" onclick="toggleZoom(${cameraIndex}, event)" title="縮放">
                            <span id="zoom-icon-${cameraIndex}">🔍</span>
                        </button>
                        <button class="video-control-btn" onclick="toggleFullscreen(${cameraIndex}, event)" title="全螢幕">
                            <span id="fullscreen-icon-${cameraIndex}">⛶</span>
                        </button>
                    </div>
                    <div class="zoom-indicator" id="zoom-indicator-${cameraIndex}">1.0x</div>
                    <img id="preview-${cameraIndex}" style="display: none;">
                    <div class="video-placeholder" id="placeholder-${cameraIndex}">
                        <div style="font-size: 3rem;">📷</div>
                        <div>點擊「開始預覽」查看畫面</div>
                    </div>
                </div>
                <div class="controls">
                    <button class="control-btn" onclick="togglePreview(${cameraIndex})">
                        👁️ <span id="preview-btn-text-${cameraIndex}">開始預覽</span>
                    </button>
                    <button class="control-btn" onclick="toggleRecording(${cameraIndex})">
                        ⏺️ <span id="record-btn-text-${cameraIndex}">開始錄影</span>
                    </button>
                </div>
                <div class="focus-control">
                    <div class="focus-label">
                        <span>手動對焦</span>
                        <span>
                            <button onclick="adjustFocus(${cameraIndex}, -10)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px;">-10</button>
                            <button onclick="adjustFocus(${cameraIndex}, -1)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px;">-1</button>
                            <span id="focus-value-${cameraIndex}">128</span>
                            <button onclick="adjustFocus(${cameraIndex}, 1)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px;">+1</button>
                            <button onclick="adjustFocus(${cameraIndex}, 10)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px;">+10</button>
                            <span id="focus-status-${cameraIndex}" style="margin-left: 8px; font-size: 0.85rem; color: #10b981; opacity: 0;">✔ 已套用</span>
                        </span>
                    </div>
                    <input type="range" class="focus-slider" id="focus-${cameraIndex}" min="0" max="255" value="128" oninput="updateFocusDisplay(${cameraIndex}, this.value)" onchange="setFocus(${cameraIndex}, this.value)">
                </div>
                <div class="focus-control">
                    <div class="focus-label">
                        <span>📸 曝光 (快門速度)</span>
                        <span>
                            <button onclick="adjustExposure(${cameraIndex}, -1)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px;">-1</button>
                            <span id="exposure-value-${cameraIndex}">-7</span>
                            <button onclick="adjustExposure(${cameraIndex}, 1)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px;">+1</button>
                            <span id="exposure-status-${cameraIndex}" style="margin-left: 8px; font-size: 0.85rem; color: #10b981; opacity: 0;">✔ 已套用</span>
                        </span>
                    </div>
                    <input type="range" class="focus-slider" id="exposure-${cameraIndex}" min="-13" max="-1" value="-7" oninput="updateExposureDisplay(${cameraIndex}, this.value)" onchange="setExposure(${cameraIndex}, this.value)">
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 4px;">
                        💡 提示：值越小 = 快門越快 = 殘影越少（需更強光線）
                    </div>
                </div>
            `;
            grid.appendChild(card);

            // 初始化拖動和縮放支援
            if (!zoomState[cameraIndex]) {
                zoomState[cameraIndex] = {
                    scale: 1,
                    offsetX: 0,
                    offsetY: 0,
                    dragging: false,
                    startX: 0,
                    startY: 0
                };
            }
            if (!wheelZoomState[cameraIndex]) {
                wheelZoomState[cameraIndex] = 1;
            }
            setupDragging(cameraIndex);
            setupWheelZoom(cameraIndex);
        }

        // 移除攝影機
        function removeCamera(cameraIndex) {
            if (!confirm(`確定要移除鏡頭 ${cameraIndex} 嗎？`)) {
                return;
            }

            // 停止預覽和錄影
            const state = cameraState[cameraIndex];
            if (state && state.recording) {
                fetch(`/api/recorder/${cameraIndex}/stop`, { method: 'POST' });
            }

            // 移除卡片
            const card = document.querySelector(`.camera-card[data-camera="${cameraIndex}"]`);
            if (card) {
                card.remove();
            }

            // 移除狀態
            delete cameraState[cameraIndex];
            activeCameras.delete(cameraIndex);
            
            // 保存配置
            saveActiveCameras();
        }

        // 切換單一鏡頭預覽
        function togglePreview(cameraIndex) {
            const state = cameraState[cameraIndex];
            const img = document.getElementById(`preview-${cameraIndex}`);
            const placeholder = document.getElementById(`placeholder-${cameraIndex}`);
            const btnText = document.getElementById(`preview-btn-text-${cameraIndex}`);
            const statusDot = document.getElementById(`status-${cameraIndex}`);
            const statusText = document.getElementById(`status-text-${cameraIndex}`);

            if (state.previewing) {
                // 停止預覽
                img.src = '';
                img.style.display = 'none';
                placeholder.style.display = 'block';
                btnText.textContent = '開始預覽';
                statusDot.classList.remove('active');
                if (!state.recording) {
                    statusText.textContent = '待機中';
                }
                state.previewing = false;
            } else {
                // 開始預覽
                img.src = `/api/recorder/${cameraIndex}/preview?t=${Date.now()}`;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                btnText.textContent = '停止預覽';
                statusDot.classList.add('active');
                statusText.textContent = '預覽中';
                state.previewing = true;

                // 載入當前對焦設定
                loadFocusSettings(cameraIndex);
            }
        }

        // 載入對焦設定
        function loadFocusSettings(cameraIndex) {
            fetch(`/api/recorder/${cameraIndex}/focus`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.focus_value !== undefined) {
                        const slider = document.getElementById(`focus-${cameraIndex}`);
                        const valueDisplay = document.getElementById(`focus-value-${cameraIndex}`);
                        if (slider && valueDisplay) {
                            slider.value = data.focus_value;
                            valueDisplay.textContent = data.focus_value;
                            console.log(`鏡頭 ${cameraIndex} 對焦值已載入: ${data.focus_value}`);
                        }
                    }
                })
                .catch(err => console.error(`鏡頭 ${cameraIndex} 對焦值載入失敗:`, err));
        }

        // 切換單一鏡頭錄影
        function toggleRecording(cameraIndex) {
            const state = cameraState[cameraIndex];
            const btnText = document.getElementById(`record-btn-text-${cameraIndex}`);
            const statusDot = document.getElementById(`status-${cameraIndex}`);
            const statusText = document.getElementById(`status-text-${cameraIndex}`);

            if (state.recording) {
                // 停止錄影
                console.log(`停止鏡頭 ${cameraIndex} 錄影`);
                fetch(`/api/recorder/${cameraIndex}/stop`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        console.log(`鏡頭 ${cameraIndex} 已停止錄影:`, data);
                        btnText.textContent = '開始錄影';
                        statusDot.classList.remove('recording');
                        if (state.previewing) {
                            statusDot.classList.add('active');
                            statusText.textContent = '預覽中';
                        } else {
                            statusText.textContent = '待機中';
                        }
                        state.recording = false;
                        loadRecordings();
                    })
                    .catch(err => console.error(`停止鏡頭 ${cameraIndex} 失敗:`, err));
            } else {
                // 開始錄影
                console.log(`開始鏡頭 ${cameraIndex} 錄影`);

                // 確保先啟動預覽
                if (!state.previewing) {
                    console.log(`先啟動鏡頭 ${cameraIndex} 預覽`);
                    togglePreview(cameraIndex);
                    // 等待預覽啟動
                    setTimeout(() => startRecordingForCamera(cameraIndex), 500);
                } else {
                    startRecordingForCamera(cameraIndex);
                }
            }
        }

        // 實際開始錄影的輔助函數
        function startRecordingForCamera(cameraIndex) {
            const state = cameraState[cameraIndex];
            const btnText = document.getElementById(`record-btn-text-${cameraIndex}`);
            const statusDot = document.getElementById(`status-${cameraIndex}`);
            const statusText = document.getElementById(`status-text-${cameraIndex}`);

            // 獲取選定的編碼器
            const codecSelect = document.getElementById('codec-select');
            const codec = codecSelect ? codecSelect.value : 'XVID';

            fetch(`/api/recorder/${cameraIndex}/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codec: codec })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log(`鏡頭 ${cameraIndex} 開始錄影:`, data);
                        btnText.textContent = '停止錄影';
                        statusDot.classList.remove('active');
                        statusDot.classList.add('recording');
                        statusText.textContent = '錄影中';
                        state.recording = true;
                    } else {
                        console.error(`鏡頭 ${cameraIndex} 開始錄影失敗:`, data.error);
                        alert(`鏡頭 ${cameraIndex} 開始錄影失敗: ${data.error || '未知錯誤'}`);
                    }
                })
                .catch(err => {
                    console.error(`鏡頭 ${cameraIndex} 錄影請求失敗:`, err);
                    alert(`鏡頭 ${cameraIndex} 錄影請求失敗，請查看控制台`);
                });
        }

        // 診斷功能：檢查錄影狀態
        function checkRecordingStatus() {
            console.log('=== 錄影狀態診斷 ===');
            console.log('globalRecording:', globalRecording);

            const cameras = Array.from(activeCameras);
            if (cameras.length === 0) {
                alert('目前沒有新增任何攝影機');
                return;
            }

            cameras.forEach(i => {
                console.log(`鏡頭 ${i} 狀態:`, {
                    previewing: cameraState[i].previewing,
                    recording: cameraState[i].recording,
                    zoomed: cameraState[i].zoomed,
                    fullscreen: cameraState[i].fullscreen
                });
            });

            // 檢查後端狀態
            Promise.all(cameras.map(i =>
                fetch(`/api/recorder/${i}/status`).then(r => r.json())
            )).then(statuses => {
                let msg = `錄影狀態診斷\n\n全域狀態: ${globalRecording ? '錄影中' : '未錄影'}\n\n`;

                cameras.forEach((camIndex, idx) => {
                    const status = statuses[idx];
                    console.log(`鏡頭 ${camIndex} 後端狀態:`, status);

                    msg += `鏡頭 ${camIndex}:\n` +
                        `  前端: ${cameraState[camIndex].recording ? '錄影中' : '未錄影'}\n` +
                        `  後端: ${status.is_recording ? '錄影中' : '未錄影'}\n` +
                        `  預覽: ${cameraState[camIndex].previewing ? '是' : '否'}\n\n`;

                    // 檢查不一致
                    if (cameraState[camIndex].recording !== status.is_recording) {
                        console.warn(`⚠️ 鏡頭 ${camIndex} 前後端狀態不一致！`);
                    }
                });

                msg += `詳細資訊請查看控制台 (F12)`;
                alert(msg);
            }).catch(err => {
                console.error('獲取後端狀態失敗:', err);
                alert('無法獲取後端狀態，請查看控制台');
            });
        }

        // 全部預覽控制
        function toggleAllPreview() {
            console.log('觸發全部預覽控制');
            const cameras = Array.from(activeCameras);
            if (cameras.length === 0) {
                alert('請先新增攝影機');
                return;
            }

            const anyPreviewing = cameras.some(i => cameraState[i].previewing);

            if (anyPreviewing) {
                // 停止所有預覽
                console.log('停止所有預覽');
                cameras.forEach(i => {
                    if (cameraState[i].previewing && !cameraState[i].recording) {
                        togglePreview(i);
                    }
                });
                document.getElementById('btn-preview-all').textContent = '👁️ 全部開始預覽';
            } else {
                // 開始所有預覽
                console.log('開始所有預覽');
                cameras.forEach(i => {
                    if (!cameraState[i].previewing) {
                        togglePreview(i);
                    }
                });
                document.getElementById('btn-preview-all').textContent = '⏸️ 全部停止預覽';
            }
        }

        // 全部錄影控制
        function toggleAllRecording() {
            console.log('觸發全部錄影控制');
            const cameras = Array.from(activeCameras);
            if (cameras.length === 0) {
                alert('請先新增攝影機');
                return;
            }

            const anyRecording = cameras.some(i => cameraState[i].recording);

            if (anyRecording) {
                // 停止所有錄影
                console.log('正在停止所有錄影...');
                cameras.forEach(i => {
                    if (cameraState[i].recording) {
                        fetch(`/api/recorder/${i}/stop`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                console.log(`鏡頭 ${i} 停止錄影`);
                                cameraState[i].recording = false;
                                const btnText = document.getElementById(`record-btn-text-${i}`);
                                if (btnText) {
                                    btnText.textContent = '開始錄影';
                                }
                                const statusDot = document.getElementById(`status-${i}`);
                                const statusText = document.getElementById(`status-text-${i}`);
                                if (statusDot && statusText) {
                                    statusDot.classList.remove('recording');
                                    if (cameraState[i].previewing) {
                                        statusDot.classList.add('active');
                                        statusText.textContent = '預覽中';
                                    } else {
                                        statusText.textContent = '待機中';
                                    }
                                }
                            })
                            .catch(err => console.error(`鏡頭 ${i} 停止失敗:`, err));
                    }
                });

                globalRecording = false;
                stopTimer();
                const btn = document.getElementById('btn-record-all');
                if (btn) {
                    btn.textContent = '⏺️ 全部開始錄影';
                    btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                }
                loadRecordings();
                console.log('所有錄影已停止');
            } else {
                // 開始所有錄影
                console.log('開始所有錄影');
                cameras.forEach(i => {
                    if (!cameraState[i].recording) {
                        toggleRecording(i);
                    }
                });
            }
        }

        // 強制停止所有錄影
        async function forceStopAllRecording() {
            console.log('🛑 執行強制停止所有錄影...');

            const cameras = Array.from(activeCameras);
            if (cameras.length === 0) {
                console.log('沒有攝影機需要停止');
                return;
            }

            const stopPromises = cameras.map(i => {
                console.log(`強制停止鏡頭 ${i}`);
                return fetch(`/api/recorder/${i}/stop`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log(`鏡頭 ${i} 強制停止回應:`, data);
                        cameraState[i].recording = false;
                        return data;
                    })
                    .catch(err => {
                        console.error(`鏡頭 ${i} 強制停止失敗:`, err);
                        cameraState[i].recording = false; // 仍然更新狀態
                    });
            });

            // 等待所有停止完成
            await Promise.all(stopPromises);

            // 更新全域狀態
            globalRecording = false;

            // 停止計時器
            stopTimer();

            // 更新按鈕
            const recordAllBtn = document.getElementById('btn-record-all');
            if (recordAllBtn) {
                recordAllBtn.textContent = '⏺️ 全部開始錄影';
                recordAllBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            }

            // 更新所有鏡頭的按鈕狀態
            cameras.forEach(i => {
                const btnText = document.getElementById(`record-btn-text-${i}`);
                if (btn) {
                    btn.textContent = '⏺️ 開始錄影';
                    btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                }
                const statusText = document.getElementById(`status-text-${i}`);
                if (statusText) {
                    statusText.textContent = cameraState[i].previewing ? '預覽中' : '待機中';
                }
            });

            // 重新載入錄影列表
            loadRecordings();

            console.log('✅ 強制停止完成');
            alert('已強制停止所有錄影！');
        }

        // 縮放狀態追蹤
        const zoomState = {
            0: { offsetX: 0, offsetY: 0, dragging: false, startX: 0, startY: 0 },
            1: { offsetX: 0, offsetY: 0, dragging: false, startX: 0, startY: 0 }
        };

        // 縮放功能
        function toggleZoom(cameraIndex, event) {
            if (event && event.target.closest('.video-control-btn')) {
                event.stopPropagation();
            }

            const container = document.getElementById(`video-container-${cameraIndex}`);
            const img = document.getElementById(`preview-${cameraIndex}`);
            const state = cameraState[cameraIndex];
            const zoomIcon = document.getElementById(`zoom-icon-${cameraIndex}`);
            const indicator = document.getElementById(`zoom-indicator-${cameraIndex}`);
            const zState = zoomState[cameraIndex];

            if (state.fullscreen) {
                return; // 全螢幕模式下不使用縮放
            }

            if (state.zoomed) {
                container.classList.remove('zoomed');
                zoomIcon.textContent = '🔍';
                state.zoomed = false;
                indicator.textContent = '1.0x';
                // 重置圖片位置
                zState.offsetX = 0;
                zState.offsetY = 0;
                updateImageTransform(cameraIndex);
            } else {
                container.classList.add('zoomed');
                zoomIcon.textContent = '🔍⊖';
                state.zoomed = true;
                indicator.textContent = '2.0x';

                // 如果點擊了圖片或容器，根據點擊位置設置縮放中心
                if (event && (event.target === img || event.target === container)) {
                    const rect = img.getBoundingClientRect();
                    const x = ((event.clientX - rect.left) / rect.width) * 100;
                    const y = ((event.clientY - rect.top) / rect.height) * 100;
                    img.style.transformOrigin = `${x}% ${y}%`;
                }
            }
        }

        // 更新圖片變換
        function updateImageTransform(cameraIndex) {
            const img = document.getElementById(`preview-${cameraIndex}`);
            const zState = zoomState[cameraIndex];
            const state = cameraState[cameraIndex];

            if (state.zoomed) {
                img.style.transform = `scale(2) translate(${zState.offsetX}px, ${zState.offsetY}px)`;
            } else {
                img.style.transform = 'scale(1)';
            }
        }

        // 為每個容器設置拖動支援
        function setupDragging(cameraIndex) {
            const container = document.getElementById(`video-container-${cameraIndex}`);
            const img = document.getElementById(`preview-${cameraIndex}`);

            if (!container || !img) {
                console.warn(`無法為鏡頭 ${cameraIndex} 設置拖動，元素不存在`);
                return;
            }

            const zState = zoomState[cameraIndex];

            container.addEventListener('mousedown', function (e) {
                if (cameraState[cameraIndex].zoomed && (e.target === img || e.target === container)) {
                    if (!e.target.closest('.video-control-btn')) {
                        zState.dragging = true;
                        zState.startX = e.clientX - zState.offsetX;
                        zState.startY = e.clientY - zState.offsetY;
                        container.style.cursor = 'grabbing';
                        e.preventDefault();
                    }
                }
            });

            document.addEventListener('mousemove', function (e) {
                if (zState.dragging) {
                    zState.offsetX = e.clientX - zState.startX;
                    zState.offsetY = e.clientY - zState.startY;
                    updateImageTransform(cameraIndex);
                    e.preventDefault();
                }
            });

            document.addEventListener('mouseup', function () {
                if (zState.dragging) {
                    zState.dragging = false;
                    if (cameraState[cameraIndex].zoomed) {
                        container.style.cursor = 'move';
                    }
                }
            });
        }

        // 滾輪縮放支援（僅在全螢幕模式下）
        const wheelZoomState = { 0: 1, 1: 1 };

        function updateZoomIndicator(cameraIndex) {
            const indicator = document.getElementById(`zoom-indicator-${cameraIndex}`);
            const scale = wheelZoomState[cameraIndex];
            indicator.textContent = `${scale.toFixed(1)}x`;

            // 短暫高亮提示
            indicator.style.background = 'rgba(16, 185, 129, 0.9)';
            setTimeout(() => {
                indicator.style.background = 'rgba(0, 0, 0, 0.7)';
            }, 300);
        }

        function setupWheelZoom(cameraIndex) {
            const container = document.getElementById(`video-container-${cameraIndex}`);
            const img = document.getElementById(`preview-${cameraIndex}`);

            if (!container || !img) {
                console.warn(`無法為鏡頭 ${cameraIndex} 設置滾輪縮放，元素不存在`);
                return;
            }

            container.addEventListener('wheel', function (e) {
                if (cameraState[cameraIndex].fullscreen) {
                    e.preventDefault();

                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    wheelZoomState[cameraIndex] = Math.min(Math.max(1, wheelZoomState[cameraIndex] + delta), 5);

                    const rect = img.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;

                    img.style.transformOrigin = `${x}% ${y}%`;
                    img.style.transform = `scale(${wheelZoomState[cameraIndex]})`;

                    updateZoomIndicator(cameraIndex);
                }
            }, { passive: false });
        }

        // 全螢幕功能
        function toggleFullscreen(cameraIndex, event) {
            event.stopPropagation();
            const container = document.getElementById(`video-container-${cameraIndex}`);
            const img = document.getElementById(`preview-${cameraIndex}`);
            const state = cameraState[cameraIndex];
            const fullscreenIcon = document.getElementById(`fullscreen-icon-${cameraIndex}`);

            if (state.fullscreen) {
                // 退出全螢幕
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                container.classList.remove('fullscreen');
                fullscreenIcon.textContent = '⛶';
                state.fullscreen = false;

                // 重置滾輪縮放
                img.style.transform = state.zoomed ? 'scale(2)' : 'scale(1)';

                // 恢復可能的縮放狀態
                if (state.zoomed) {
                    container.classList.add('zoomed');
                    updateImageTransform(cameraIndex);
                }
            } else {
                // 進入全螢幕
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.mozRequestFullScreen) {
                    container.mozRequestFullScreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
                container.classList.add('fullscreen');
                container.classList.remove('zoomed'); // 全螢幕時移除縮放
                fullscreenIcon.textContent = '⛶⊖';
                state.fullscreen = true;

                // 保存縮放狀態但暫時不顯示
                const wasZoomed = state.zoomed;
                state.zoomed = false;

                // 重置圖片變換
                img.style.transform = 'scale(1)';
            }
        }

        // 監聽全螢幕變化事件（用戶按 ESC 退出）
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement);

            if (!isFullscreen) {
                // 用戶退出了全螢幕，更新狀態
                Array.from(activeCameras).forEach(i => {
                    if (cameraState[i] && cameraState[i].fullscreen) {
                        const container = document.getElementById(`video-container-${i}`);
                        const img = document.getElementById(`preview-${i}`);
                        const fullscreenIcon = document.getElementById(`fullscreen-icon-${i}`);

                        container.classList.remove('fullscreen');
                        fullscreenIcon.textContent = '⛶';
                        cameraState[i].fullscreen = false;

                        // 重置滾輪縮放
                        wheelZoomState[i] = 1;

                        // 恢復原本的縮放狀態
                        if (cameraState[i].zoomed) {
                            container.classList.add('zoomed');
                            updateImageTransform(i);
                        } else {
                            img.style.transform = 'scale(1)';
                        }
                    }
                });
            }
        }

        // 更新對焦顯示（拖動時即時更新數值）
        function updateFocusDisplay(cameraIndex, value) {
            document.getElementById(`focus-value-${cameraIndex}`).textContent = value;
            // 微調對焦值
            function adjustFocus(cameraIndex, delta) {
                const slider = document.getElementById(`focus-${cameraIndex}`);
                const currentValue = parseInt(slider.value);
                const newValue = Math.max(0, Math.min(255, currentValue + delta));

                ider.value = newValue;
                updateFocusDisplay(cameraIndex, newValue);
                setFocus(cameraIndex, newValue);
            }

            // 設定對焦（釋放滑桿時套用）
            function setFocus(cameraIndex, value) {
                const statusEl = document.getElementById(`focus-status-${cameraIndex}`);

                fetch(`/api/recorder/${cameraIndex}/focus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        focus: parseInt(value),
                        auto: false  // 手動調整時關閉自動對焦
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`鏡頭 ${cameraIndex} 對焦設定為: ${value}`, data.saved ? '(已儲存)' : '');
                            // 顯示「已套用並儲存」提示
                            statusEl.textContent = data.saved ? '✔ 已套用並儲存' : '✔ 已套用';
                            statusEl.style.opacity = '1';
                            setTimeout(() => {
                                statusEl.style.opacity = '0';
                            }, 2000);
                        } else {
                            console.error(`鏡頭 ${cameraIndex} 對焦設定失敗:`, data.error);
                            statusEl.textContent = '❌ 設定失敗';
                            statusEl.style.color = '#ef4444';
                            statusEl.style.opacity = '1';
                            setTimeout(() => {
                                statusEl.style.opacity = '0';
                                statusEl.textContent = '✔ 已套用';
                                statusEl.style.color = '#10b981';
                            }, 2000);
                        }
                    })
                    .catch(err => {
                        console.error(`鏡頭 ${cameraIndex} 對焦設定請求失敗:`, err);
                        statusEl.textContent = '❌ 請求失敗';
                        statusEl.style.color = '#ef4444';
                        statusEl.style.opacity = '1';
                        setTimeout(() => {
                            statusEl.style.opacity = '0';
                            statusEl.textContent = '✔ 已套用';
                            statusEl.style.color = '#10b981';
                        }, 2000);
                    });
            }

            // === 曝光控制函數 ===
            function updateExposureDisplay(cameraIndex, value) {
                document.getElementById(`exposure-value-${cameraIndex}`).textContent = value;
            }

            // 微調曝   function adjustExposure(cameraIndex, delta) {
            const slider = document.getElementById(`exposure-${cameraIndex}`);
            const currentValue = parseInt(slider.value);
            const newValue = Math.max(-13, Math.min(-1, currentValue + delta));

            slider.vale;
            updateExposureDisplay(cameraIndex, newValue);
            setExposure(cameraIndex, newValue);
        }

        // 設定曝光值（釋放滑桿時套用）
        function setExposure(cameraIndex, value) {
            const statusEl = document.getElementById(`exposure-status-${cameraIndex}`);

            fetch(`/api/recorder/${cameraIndex}/exposure`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    exposure: parseInt(value),
                    auto: false,
                    save: true  // 自動儲存
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log(`鏡頭 ${cameraIndex} 曝光設定為: ${value}`, data.saved ? '(已儲存)' : '');
                        statusEl.textContent = data.saved ? '✔ 已套用並儲存' : '✔ 已套用';
                        statusEl.style.opacity = '1';
                        setTimeout(() => {
                            statusEl.style.opacity = '0';
                        }, 2000);
                    } else {
                        console.error(`鏡頭 ${cameraIndex} 曝光設定失敗:`, data.error);
                        statusEl.textContent = '❌ 設定失敗';
                        statusEl.style.color = '#ef4444';
                        statusEl.style.opacity = '1';
                        setTimeout(() => {
                            statusEl.style.opacity = '0';
                            statusEl.textContent = '✔ 已套用';
                            statusEl.style.color = '#10b981';
                        }, 2000);
                    }
                })
                .catch(err => {
                    console.error(`鏡頭 ${cameraIndex} 曝光設定請求失敗:`, err);
                    statusEl.textContent = '❌ 請求失敗';
                    statusEl.style.color = '#ef4444';
                    statusEl.style.opacity = '1';
                    setTimeout(() => {
                        statusEl.style.opacity = '0';
                        statusEl.textContent = '✔ 已套用';
                        statusEl.style.color = '#10b981';
                    }, 2000);
                });
        }

        // 計時器
        function startTimer() {
            recordingStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('global-timer').textContent = '00:00:00';
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            document.getElementById('global-timer').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // 檢查檔案是否正在錄影中
        function checkIfRecording(filename) {
            // 從檔案名稱提取鏡頭編號（例如：0_20251203_151453.mp4）
            const match = filename.match(/^(\d+)_/);
            if (match) {
                const cameraIndex = parseInt(match[1]);
                if (cameraState[cameraIndex]) {
                    return cameraState[cameraIndex].recording;
                }
            }
            return false;
        }

        // 載入錄影列表
        function loadRecordings() {
            fetch('/api/recorder/recordings')
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('recordings-list');
                    if (data.recordings && data.recordings.length > 0) {
                        list.innerHTML = data.recordings.map(r => {
                            // 檢查檔案是否正在錄影中
                            const isRecording = checkIfRecording(r.name);
                            const recordingBadge = isRecording ?
                                `<span style="background: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">⏺️ 錄影中</span>` : '';
                            const deleteDisabled = isRecording ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '';

                            return `
                                <div class="recording-item" style="display: flex; align-items: center; gap: 12px;">
                                    <input type="checkbox" 
                                           class="recording-checkbox" 
                                           data-filename="${r.name}"
                                           ${isRecording ? 'disabled' : ''}
                                           style="cursor: pointer; width: 18px; height: 18px; ${isRecording ? 'opacity: 0.3;' : ''}"
                                           onchange="updateRecordingSelection()">
                                    <div class="recording-info" style="flex: 1;">
                                        <div class="recording-name">${r.name}${recordingBadge}</div>
                                        <div class="recording-meta">${r.size} | ${r.date}</div>
                                    </div>
                                    <div class="recording-actions">
                                        <button class="action-btn" id="btn-extract-${r.name}" onclick="extractVideoFrames('${r.name}')" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">📷 擷取圖像</button>
                                        <a href="/recordings/${r.name}" class="action-btn">⬇️ 下載</a>
                                        <button class="action-btn delete" ${deleteDisabled} onclick="deleteRecording('${r.name}')">🗑️ 刪除</button>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        // 顯示全選、批次擷取和批次刪除按鈕
                        document.getElementById('select-all-recordings-btn').style.display = 'block';
                        document.getElementById('batch-extract-btn').style.display = 'block';
                        document.getElementById('batch-delete-recordings-btn').style.display = 'block';
                    } else {
                        list.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">目前沒有錄影檔案</div>';

                        // 隱藏全選、批次擷取和批次刪除按鈕
                        document.getElementById('select-all-recordings-btn').style.display = 'none';
                        document.getElementById('batch-extract-btn').style.display = 'none';
                        document.getElementById('batch-delete-recordings-btn').style.display = 'none';
                    }
                })
                .catch(err => {
                    document.getElementById('recordings-list').innerHTML =
                        '<div style="text-align: center; color: #f87171; padding: 20px;">載入失敗</div>';
                });
        }

        // 刪除錄影
        function deleteRecording(filename) {
            if (confirm(`確定要刪除 ${filename} 嗎？`)) {
                fetch(`/api/recorder/recordings/${filename}`, { method: 'DELETE' })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(data => {
                                throw { status: res.status, data: data };
                            });
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.success) {
                            loadRecordings();
                        } else {
                            alert('刪除失敗: ' + (data.error || '未知錯誤'));
                        }
                    })
                    .catch(err => {
                        if (err.status === 409 && err.data) {
                            // 檔案正在使用中
                            if (err.data.camera_index !== undefined) {
                                alert(`⚠️ 無法刪除\n\n${err.data.error}\n\n請先停止鏡頭 ${err.data.camera_index} 的錄影，再嘗試刪除。`);
                            } else {
                                alert(`⚠️ 無法刪除\n\n${err.data.error}`);
                            }
                        } else if (err.data && err.data.error) {
                            alert('刪除失敗: ' + err.data.error);
                        } else {
                            alert('刪除失敗: ' + (err.message || '未知錯誤'));
                        }
                    });
            }
        }

        // 全選狀態
        let allRecordingsSelected = false;

        // 切換全選/反選
        function toggleSelectAllRecordings() {
            const checkboxes = document.querySelectorAll('.recording-checkbox:not(:disabled)');
            const btn = document.getElementById('select-all-recordings-btn');

            allRecordingsSelected = !allRecordingsSelected;

            checkboxes.forEach(checkbox => {
                checkbox.checked = allRecordingsSelected;
            });

            btn.textContent = allRecordingsSelected ? '☑ 取消全選' : '☐ 全選';
            updateRecordingSelection();
        }

        // 更新選擇狀態
        function updateRecordingSelection() {
            const checkboxes = document.querySelectorAll('.recording-checkbox:not(:disabled)');
            const checkedBoxes = document.querySelectorAll('.recording-checkbox:checked');
            const btn = document.getElementById('select-all-recordings-btn');
            const batchDeleteBtn = document.getElementById('batch-delete-recordings-btn');
            const batchExtractBtn = document.getElementById('batch-extract-btn');

            // 更新全選按鈕文字
            if (checkedBoxes.length === checkboxes.length && checkboxes.length > 0) {
                btn.textContent = '☑ 取消全選';
                allRecordingsSelected = true;
            } else {
                btn.textContent = '☐ 全選';
                allRecordingsSelected = false;
            }

            // 更新批量操作按鈕文字
            if (checkedBoxes.length > 0) {
                batchExtractBtn.textContent = `📷 批量擷取圖像 (${checkedBoxes.length})`;
                batchDeleteBtn.textContent = `🗑️ 刪除選中 (${checkedBoxes.length})`;
            } else {
                batchExtractBtn.textContent = '📷 批量擷取圖像';
                batchDeleteBtn.textContent = '🗑️ 刪除選中';
            }
        }

        // 批量刪除錄影
        function batchDeleteRecordings() {
            const checkedBoxes = document.querySelectorAll('.recording-checkbox:checked');

            if (checkedBoxes.length === 0) {
                alert('請先選擇要刪除的錄影檔案');
                return;
            }

            const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

            if (!confirm(`確定要刪除 ${filenames.length} 個錄影檔案嗎？\n\n${filenames.slice(0, 5).join('\n')}${filenames.length > 5 ? '\n...' : ''}`)) {
                return;
            }

            // 批次刪除
            let successCount = 0;
            let failCount = 0;

            Promise.all(filenames.map(filename =>
                fetch(`/api/recorder/recordings/${filename}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) successCount++;
                        else failCount++;
                    })
                    .catch(() => failCount++)
            )).then(() => {
                alert(`批量刪除完成！\n成功: ${successCount} 個\n失敗: ${failCount} 個`);
                loadRecordings();
            });
        }

        // 批量擷取圖像
        function batchExtractFrames() {
            const checkedBoxes = document.querySelectorAll('.recording-checkbox:checked');

            if (checkedBoxes.length === 0) {
                alert('請先選擇要擷取圖像的錄影檔案');
                return;
            }

            const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

            if (!confirm(`確定要從 ${filenames.length} 個錄影檔案中擷取圖像嗎？\n\n${filenames.slice(0, 5).join('\n')}${filenames.length > 5 ? '\n...' : ''}\n\n這可能需要一些時間。`)) {
                return;
            }

            // 批次擷取
            let successCount = 0;
            let failCount = 0;
            let totalFrames = 0;

            alert(`開始批量擷取，共 ${filenames.length} 個檔案...\n請稍候，處理完成後會顯示結果。`);

            Promise.all(filenames.map(filename =>
                fetch(`/api/recorder/extract-frames/${filename}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            successCount++;
                            totalFrames += data.frames_extracted || 0;
                        } else {
                            failCount++;
                        }
                    })
                    .catch(() => failCount++)
            )).then(() => {
                alert(`批量擷取完成！\n\n成功: ${successCount} 個檔案\n失敗: ${failCount} 個檔案\n共擷取: ${totalFrames} 張圖片`);
            });
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', function (e) {
            // ESC 鍵：退出全螢幕或縮放
            if (e.key === 'Escape') {
                Array.from(activeCameras).forEach(i => {
                    const state = cameraState[i];
                    if (state && state.fullscreen) {
                        toggleFullscreen(i, e);
                    } else if (state.zoomed) {
                        toggleZoom(i, e);
                    }
                });
            }

            // F 鍵：切換第一個鏡頭全螢幕
            if (e.key === 'f' || e.key === 'F') {
                if (!e.ctrlKey && !e.altKey) {
                    e.preventDefault();
                    toggleFullscreen(0, e);
                }
            }

            // Z 鍵：切換第一個鏡頭縮放
            if (e.key === 'z' || e.key === 'Z') {
                if (!e.ctrlKey && !e.altKey) {
                    e.preventDefault();
                    toggleZoom(0, e);
                }
            }
        });

        // 切換教學指南
        function toggleGuide() {
            const content = document.getElementById('guide-content');
            const btn = document.getElementById('guide-toggle-btn');

            if (content.classList.contains('active')) {
                content.classList.remove('active');
                btn.textContent = '展開教學 ▼';
            } else {
                content.classList.add('active');
                btn.textContent = '收起教學 ▲';
            }
        }

        // 定期刷新錄影列表（當有錄影進行時）
        function startRecordingListRefresh() {
            setInterval(() => {
                // 檢查是否有任何鏡頭正在錄影
                const anyRecording = Array.from(activeCameras).some(i =>
                    cameraState[i] && cameraState[i].recording
                );
                if (anyRecording) {
                    loadRecordings();
                }
            }, 5000); // 每 5 秒刷新一次
        }

        // 擷取單個影片圖像
        async function extractVideoFrames(filename) {
            const interval = prompt('擷取間隔（每幾幀取一張）：', '30');
            if (interval === null) return;

            const maxFrames = prompt('最大擷取數量：', '100');
            if (maxFrames === null) return;

            const btn = document.getElementById(`btn-extract-${filename}`);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '⏳ 處理中...';

            try {
                const response = await fetch('/aecotract_frames', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: filename,
                        interval: parseInt(interval),
                        max_frames: parseInt(maxFrames)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`✅ 擷取完成！\n影片: ${data.video}\n共擷取: ${data.count} 張影像\n您可以到標註頁面查看這些影像。`);
                } else {
                    alert(`❌ 擷取失敗: ${data.error}`);
                }
            } catch (error) {
                console.error('擷取請求失敗:', error);
                alert(`❌ 請求失敗: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // 擷取圖像 (全域 - 已棄用或保留給舊功能)
        async function extractFramesNow() {
            // ... existing batch function if needed ...
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            loadRecordings();

            // 載入兩個鏡頭的對焦設定
            loadFocusSettings(0);
            loadFocusSettings(1);

            // 啟動定期刷新
            startRecordingListRefresh();

            // 首次訪問時自動展開教學（可選）
            const hasVisited = localStorage.getItem('recorder_guide_visited');
            if (!hasVisited) {
                toggleGuide();
                localStorage.setItem('recorder_guide_visited', 'true');
            }
        });

        function restartApp() {
            if (confirm('您確定要重啟應用程式嗎？目前的連線將會中斷。')) {
                fetch('/api/system/restart', { method: 'POST' })
                    .then(() => console.log('Restart command sent.'))
                    .catch(e => console.error('Restart command sent, server shutting down:', e));
                setTimeout(() => location.reload(), 5000);
            }
        }
    </script>
</body>

</html>