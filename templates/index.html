<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³–æœç‘•ç–µåµæ¸¬ç³»çµ±</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ¬ ç³–æœç‘•ç–µåµæ¸¬ç³»çµ±</h1>
                    <nav class="nav-tabs">
                        <button class="nav-btn active" id="tab-dashboard">å„€è¡¨æ¿</button>
                        <button class="nav-btn" id="tab-history">æ­·å²è¨˜éŒ„</button>
                        <button class="nav-btn" id="tab-settings">ç³»çµ±è¨­å®š</button>
                        <a href="/recorder" class="nav-btn recorder-link">ğŸ¥ éŒ„å½±</a>
                        <a href="/trainer" class="nav-btn trainer-link">ğŸ¤– è¨“ç·´</a>
                        <a href="/annotate" class="nav-btn annotate-link">ğŸ·ï¸ æ¨™è¨»</a>
                        <button class="nav-btn" onclick="restartApp()" title="é‡å•Ÿæ‡‰ç”¨ç¨‹å¼">ğŸ”„</button>
                    </nav>
                </div>
                <div class="font-controls">
                    <button class="btn-font" id="btn-theme-toggle" title="åˆ‡æ›ç‚ºå¤œé–“æ¨¡å¼">ğŸŒ™</button>
                    <button class="btn-font" onclick="changeZoom('decrease')" title="ç¸®å°å­—é«”">A-</button>
                    <button class="btn-font" onclick="changeZoom('reset')" title="é‡è¨­å­—é«”">é‡è¨­</button>
                    <button class="btn-font" onclick="changeZoom('increase')" title="æ”¾å¤§å­—é«”">A+</button>
                </div>
            </div>
        </header>

        <!-- å„€è¡¨æ¿é é¢ -->
        <div id="dashboard" class="tab-content active">
            <!-- å³æ™‚çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-container" id="statsContainer">
                <!-- å‹•æ…‹ç”¢ç”Ÿçµ±è¨ˆå¡ç‰‡ -->
            </div>

            <!-- æ”å½±æ©Ÿæ§åˆ¶ -->
            <div class="camera-controls">
                <button id="btn-pause-cameras" class="btn-pause" onclick="togglePauseCameras()">
                    â¸ï¸ æš«åœæ‰€æœ‰é¡é ­
                </button>
                <button id="btn-detect-cameras" class="btn-detect" onclick="detectCameras()">
                    ğŸ” é‡æ–°åµæ¸¬é¡é ­
                </button>
                <div class="camera-selector">
                    <label>æ–°å¢æ”å½±æ©Ÿï¼š</label>
                    <select id="available-cameras">
                        <option value="">-- é¸æ“‡æ”å½±æ©Ÿ --</option>
                    </select>
                    <button class="btn-add-camera" onclick="addSelectedCamera()">
                        â• æ–°å¢
                    </button>
                </div>
                <div class="model-selector">
                    <label>ğŸ¤– æ¨¡å‹ç‰ˆæœ¬ï¼š</label>
                    <select id="model-versions" onchange="switchModel()">
                        <option value="">-- è¼‰å…¥ä¸­ --</option>
                    </select>
                    <span id="model-info" class="model-info"></span>
                </div>
            </div>

            <!-- æ”å½±æ©Ÿç•«é¢ -->
            <div class="video-container" id="videoContainer">
                <!-- å‹•æ…‹ç”¢ç”Ÿæ”å½±æ©Ÿç•«é¢ -->
            </div>

            <!-- å³æ™‚åœ–è¡¨ -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>ç‘•ç–µç‡è¶¨å‹¢</h3>
                    <canvas id="defectRateChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ç”¢å“åˆ†å¸ƒ</h3>
                    <canvas id="productPieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ­·å²è¨˜éŒ„é é¢ -->
        <div id="history" class="tab-content">
            <div class="history-controls">
                <label>
                    æ™‚é–“ç¯„åœï¼š
                    <select id="historyHours" onchange="loadHistory()">
                        <option value="1">éå» 1 å°æ™‚</option>
                        <option value="6">éå» 6 å°æ™‚</option>
                        <option value="24" selected>éå» 24 å°æ™‚</option>
                        <option value="168">éå» 7 å¤©</option>
                        <option value="720">éå» 30 å¤©</option>
                        <option value="0">å…¨éƒ¨è¨˜éŒ„</option>
                    </select>
                </label>
                <label>
                    æ”å½±æ©Ÿï¼š
                    <select id="historyCamera" onchange="loadHistory()">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </label>
                <button onclick="exportHistory()" class="btn-export">åŒ¯å‡º CSV</button>
            </div>

            <div class="history-table-container">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>æ”å½±æ©Ÿ</th>
                            <th>ç¸½æ•¸</th>
                            <th>æ­£å¸¸å“</th>
                            <th>ç‘•ç–µå“</th>
                            <th>ç‘•ç–µç‡</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç³»çµ±è¨­å®šé é¢ -->
        <div id="settings" class="tab-content">
            <div class="settings-container">
                <h2>åµæ¸¬æ¨¡å‹é¸æ“‡</h2>
                <div class="settings-group model-select-group">
                    <label>ç›®å‰ä½¿ç”¨çš„æ¨¡å‹ï¼š</label>
                    <select id="modelSelect" class="model-select">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                    <button onclick="changeModel()" class="btn-change-model">ğŸ”„ åˆ‡æ›æ¨¡å‹</button>
                    <div id="currentModelInfo" class="model-info"></div>
                </div>

                <h2>åµæ¸¬åƒæ•¸è¨­å®š</h2>
                <div class="settings-group">
                    <label>
                        ä¿¡å¿ƒåº¦é–¾å€¼ (Confidence Threshold)ï¼š
                        <input type="number" id="confThreshold" step="0.05" min="0" max="1" value="0.2">
                    </label>
                </div>
                <div class="settings-group">
                    <label>
                        NMS é–¾å€¼ (NMS Threshold)ï¼š
                        <input type="number" id="nmsThreshold" step="0.05" min="0" max="1" value="0.4">
                    </label>
                </div>

                <h2>æ”å½±æ©Ÿè¨­å®š</h2>
                <div id="cameraSettings">
                    <!-- å‹•æ…‹è¼‰å…¥æ”å½±æ©Ÿè¨­å®š -->
                </div>

                <button onclick="saveSettings()" class="btn-save">å„²å­˜è¨­å®š</button>
                <div id="settingsMessage" class="message"></div>
            </div>
            <div class="settings-container" style="margin-top: 20px;">
                <div class="settings-group system-actions">
                    <h2>ç³»çµ±æ“ä½œ</h2>
                    <button onclick="restartApp()" class="btn-restart">ğŸ”„ é‡å•Ÿæ‡‰ç”¨ç¨‹å¼</button>
                    <p class="settings-note">æ³¨æ„ï¼šé»æ“Šå¾Œæ‡‰ç”¨ç¨‹å¼å°‡æœƒé‡å•Ÿï¼Œç›®å‰çš„é€£ç·šæœƒä¸­æ–·ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä¸»é¡Œï¼ˆæ—¥é–“/å¤œé–“ï¼‰- ç›¡é‡åœ¨å¤–éƒ¨è…³æœ¬å‰åŸ·è¡Œä»¥é¿å… FOUC
        (function () {
            const THEME_KEY = 'theme';
            function determinePreferredTheme() {
                const saved = localStorage.getItem(THEME_KEY);
                if (saved === 'light' || saved === 'dark') return saved;
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                return prefersDark ? 'dark' : 'light';
            }
            function applySavedTheme() {
                const theme = determinePreferredTheme();
                document.body.classList.toggle('dark-mode', theme === 'dark');
                updateThemeToggleIcon();
            }
            function updateThemeToggleIcon() {
                const btn = document.getElementById('btn-theme-toggle');
                if (!btn) return;
                const isDark = document.body.classList.contains('dark-mode');
                btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
                btn.title = isDark ? 'åˆ‡æ›ç‚ºæ—¥é–“æ¨¡å¼' : 'åˆ‡æ›ç‚ºå¤œé–“æ¨¡å¼';
            }
            function toggleTheme() {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
                updateThemeToggleIcon();
            }
            document.addEventListener('DOMContentLoaded', function () {
                applySavedTheme();
                var themeBtn = document.getElementById('btn-theme-toggle');
                if (themeBtn) {
                    themeBtn.addEventListener('click', toggleTheme);
                }
            });
        })();
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // åˆ†é æŒ‰éˆ•äº‹ä»¶ç¶å®š - ç¢ºä¿ DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            var tabDashboard = document.getElementById('tab-dashboard');
            var tabHistory = document.getElementById('tab-history');
            var tabSettings = document.getElementById('tab-settings');

            if (tabDashboard) {
                tabDashboard.onclick = function () {
                    showTab('dashboard', this);
                };
            }
            if (tabHistory) {
                tabHistory.onclick = function () {
                    showTab('history', this);
                };
            }
            if (tabSettings) {
                tabSettings.onclick = function () {
                    showTab('settings', this);
                };
            }

            console.log('åˆ†é æŒ‰éˆ•å·²ç¶å®š');
        });
    </script>
</body>

</html>