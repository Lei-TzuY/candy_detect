# 手動對焦功能修復說明

## 🔧 已修復的問題

手動對焦設定無法正確儲存和套用到攝影機的問題已解決。

## ✨ 改進內容

### 1. **前端改進**
- ✅ 調整滑桿時明確傳送 `auto: false` 關閉自動對焦
- ✅ 添加「✔ 已套用」視覺反饋，確認設定成功
- ✅ 滑桿拖動時即時更新數值（`oninput`）
- ✅ 釋放滑桿時套用設定（`onchange`）
- ✅ 頁面載入時自動讀取當前對焦值
- ✅ 啟動預覽時自動同步對焦設定
- ✅ 添加錯誤處理和失敗提示

### 2. **後端改進**
- ✅ 先關閉自動對焦，再設定手動對焦值
- ✅ 添加 0.1 秒延遲確保設定生效
- ✅ 驗證實際套用的對焦值
- ✅ 詳細的日誌輸出便於診斷
- ✅ 攝影機連接狀態檢查
- ✅ 從攝影機讀取當前對焦值

### 3. **視覺改進**
- ✅ 滑桿拖動時即時顯示數值變化
- ✅ 釋放滑桿後顯示「✔ 已套用」提示（2秒後淡出）
- ✅ 設定失敗時顯示「❌ 設定失敗」紅色提示
- ✅ 平滑的動畫過渡效果
- ✅ 滑桿按鈕 hover 和 active 狀態反饋

## 🧪 測試步驟

### 基本測試
1. 開啟錄影頁面：http://localhost:5000/recorder
2. 點擊「👁️ 全部開始預覽」
3. 調整任一鏡頭的「手動對焦」滑桿
4. 觀察右側顯示「✔ 已套用」提示（綠色，2秒後消失）
5. 查看預覽畫面是否對焦變化

### 進階測試
1. 調整對焦值到 100
2. 重新整理頁面
3. 再次啟動預覽
4. 確認滑桿顯示的值為 100（表示設定已保存）

### 控制台檢查
開啟瀏覽器開發者工具（F12），查看 Console：
- ✅ 應顯示：`鏡頭 0 對焦設定為: [值]`
- ✅ 應顯示：`鏡頭 0 對焦值已載入: [值]`
- ❌ 不應出現錯誤訊息

### 後端日誌檢查
查看終端機的 Python 輸出：
```
攝影機 0: 手動對焦設定為 100 - 成功
攝影機 0: 實際對焦值: 100.0
```

## ⚠️ 注意事項

### 攝影機支援度
部分攝影機可能不支援軟體控制對焦：
- 請確認您的攝影機支援 `CAP_PROP_AUTOFOCUS` 和 `CAP_PROP_FOCUS`
- 如果設定失敗，可能需要使用攝影機本身的對焦環或按鈕

### 對焦範圍
- 預設範圍：0-255
- 不同攝影機的對焦範圍可能不同
- 建議逐步調整找到最清晰的值

### 共享攝影機模式
- 錄影系統與偵測系統共享攝影機
- 對焦設定會影響兩個系統的畫面
- 建議在開始偵測前先調整好對焦

## 🔍 故障排除

### 問題：調整滑桿沒有反應
**解決方案：**
1. 確認攝影機預覽已啟動
2. 檢查攝影機是否支援軟體對焦控制
3. 查看控制台是否有錯誤訊息

### 問題：顯示「設定失敗」
**可能原因：**
1. 攝影機未連接或未啟動
2. 攝影機不支援手動對焦控制
3. USB 連接不穩定

**解決方案：**
1. 重新啟動預覽
2. 重新插拔 USB 攝影機
3. 檢查攝影機驅動程式

### 問題：重新整理後對焦值重置
**確認：**
1. 這可能是正常行為（攝影機重新初始化）
2. 每次啟動時可以快速重新調整
3. 考慮記錄最佳對焦值以便快速設定

## 📝 技術細節

### 對焦設定流程
```
1. 用戶拖動滑桿
   ↓
2. oninput 即時更新顯示數值
   ↓
3. 用戶釋放滑桿
   ↓
4. onchange 觸發 setFocus()
   ↓
5. 發送 POST 請求到 /api/recorder/{camera}/focus
   ↓
6. 後端關閉自動對焦
   ↓
7. 延遲 0.1 秒
   ↓
8. 套用手動對焦值
   ↓
9. 驗證實際對焦值
   ↓
10. 回傳成功/失敗狀態
   ↓
11. 前端顯示「✔ 已套用」或「❌ 設定失敗」
```

### API 請求格式
```json
POST /api/recorder/0/focus
{
  "focus": 100,
  "auto": false
}
```

### API 回應格式
```json
{
  "success": true,
  "auto_focus": false,
  "focus_value": 100,
  "message": "對焦已設定為 100 (自動對焦: 關閉)"
}
```

## 🎯 最佳實踐

1. **調整對焦前先啟動預覽**
   - 可以即時看到對焦變化效果
   
2. **從中間值開始調整**
   - 預設值 128 是一個合理的起點
   - 根據畫面清晰度上下微調

3. **記錄最佳對焦值**
   - 每個攝影機的最佳值可能不同
   - 建議記錄在 `config.ini` 或便簽中

4. **定期檢查對焦**
   - 長時間使用後可能需要微調
   - 更換攝影機位置後需重新調整

## 📞 需要協助？

如果仍有問題，請提供：
1. 攝影機型號
2. 控制台錯誤訊息
3. 後端日誌輸出
4. 問題發生步驟
