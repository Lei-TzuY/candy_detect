# ? Candy Defect Detection System
# 蝟??敶勗??菜葫蝟餌絞

[![Python](https://img.shields.io/badge/Python-3.11+-blue.svg)](https://www.python.org/)
[![OpenCV](https://img.shields.io/badge/OpenCV-4.x-green.svg)](https://opencv.org/)
[![YOLOv8](https://img.shields.io/badge/YOLO-v8%20%7C%20v4-orange.svg)](https://github.com/ultralytics/ultralytics)
[![Flask](https://img.shields.io/badge/Flask-3.x-lightgrey.svg)](https://flask.palletsprojects.com/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

?箸 **YOLOv8** ??**OpenCV** ???渡????萄皜祈圾瘙箸獢????單?敶勗??菜葫????閮颯芋??蝺渲? Web 蝞∠?隞??

## ????寡

### ? ?詨??
- ? **憭?敶望??單??菜葫** - ?舀????憭楝?蔣璈??舐蝡?蝵?
- ?? **?芋???* - YOLOv8 (銝餅) / YOLOv4-tiny ?暑??
- ??**蝜潮?刻???* - HTTP API 閫貊嚗祕?曇???
- ?? **?單?蝯梯??風??* - SQLite 鞈?摨怨????舀?臬 CSV

### ?? Web 蝞∠?隞
- ?? **?單???** - ??敶望??恍?皜祉絞閮PU 雿輻??
- ? **?蔣蝞∠?** - 敶梁??ˊ???整撘??甈∟???
- ?儭?**鞈?璅酉** - LabelImg ?游??I ?芸?璅酉??銴??皜?
- ?? **璅∪?閮毀** - YOLOv8 閮毀隞??脣漲????蝺湔蝺?

### ? ?脤??
- ? **ROI ??皜?* - ?芾??菜葫??????
- ?? **???** - FPS?PU 閮擃隢??蕭頩?
- ?? **?梢?頛?* - 閮剖?霈?⊿???
- ?? **摰?亥?** - 憭惜蝝隤頂蝯梧??嫣噶?日

## ?? 撠?蝯?

```
candy/
??? src/                          # ?詨???蝣?
??  ??? web_app.py               # Flask Web ?銝餌?撘?
??  ??? run_detector.py          # ?單??菜葫銝餌?撘?
??  ??? video_recorder.py        # 敶梁??ˊ璅∠?
??  ??? yolov8_trainer.py        # YOLOv8 閮毀璅∠?
??  ??? data_cleaning.py         # 鞈?皜?撌亙
??
??? candy_detector/               # ?詨?憟辣璅∠?
??  ??? config.py                # 閮剖?頛
??  ??? logger.py                # ?亥?蝟餌絞
??  ??? models.py                # 鞈?璅∪?
??  ??? optimization.py          # ??芸?
??
??? templates/                    # Web 隞璅⊥
??  ??? index.html               # 擐? (?單???)
??  ??? recorder.html            # ?蔣蝞∠?
??  ??? annotate.html            # 鞈?璅酉
??  ??? trainer.html             # 璅∪?閮毀
??
??? static/                       # ??鞈?
??  ??? annotate.js              # 璅酉隞?摩
??  ??? recorder.js              # ?蔣隞?摩
??  ??? trainer.js               # 閮毀隞?摩
??
??? datasets/                     # 鞈????
??  ??? extracted_frames/        # ?瑕??蔣??
??  ??? annotated/               # 璅酉鞈?
??  ??? candy/                   # YOLO 閮毀鞈???
??
??? models/                       # YOLOv4 璅∪?瑼?
??? runs/                         # YOLOv8 閮毀蝯?
??? recordings/                   # ?蔣瑼?
??? logs/                         # ?瑁??亥?
??? docs/                         # 撠???
??
??? config.ini                    # 蝟餌絞閮剖?瑼?
??? requirements.txt              # Python 憟辣靘陷
??? train_yolo.py                 # 閮毀?單 (CLI)
??? auto_label.py                 # ?芸?璅酉撌亙
??? *.bat                         # Windows ???單
```

## ?? 敹恍?憪?

### 1儭 ?啣??瘙?

- **Python 3.11+**
- **OpenCV 4.x**
- **(?舫) CUDA 11.8+ / cuDNN** - GPU ??蝺渲??刻?
- **?蔣璈身??* - ?舀 USB / IP Camera

### 2儭 摰?

```bash
# ??撠?
git clone https://github.com/your-username/candy-defect-detection.git
cd candy-defect-detection

# 撱箇???啣? (撱箄降)
python -m venv .venv

# ???啣?
.venv\Scripts\activate        # Windows
source .venv/bin/activate     # Linux/Mac

# 摰?靘陷
pip install -r requirements.txt
```

### 3儭 閮剖??銵?

#### ?? ?寞? 1嚗eb 隞 (?刻)

```bash
# ?? Web ?
python src/web_app.py

# ?蝙?冽甈⊥?
start_all.bat              # Windows: ?? Web + ?菜葫
```

???汗?刻赤??`http://localhost:5000`

#### ? ?寞? 2嚗隞文?璅∪?

```bash
# ?格?敶望?
python src/run_detector.py Camera1

# ??敶望?
python src/run_detector.py Camera1 Camera2
```

### 4儭 閮剖?瑼?

蝺刻摩 `config.ini` 隤踵蝟餌絞?嚗?

```ini
[Paths]
weights = runs/train/candy_detector/weights/best.pt  # YOLOv8 璅∪?頝臬?
classes = models/classes.txt                          # 憿?迂

[Detection]
confidence_threshold = 0.5    # 蝵桐縑摨阡?瑼?
nms_threshold = 0.4           # NMS ?瑼?
input_size = 640              # 頛詨撠箏站

[Camera1]
index = 0                     # ?蔣璈揣撘?
width = 1280                  # 閫??摨血祝
height = 720                  # 閫??摨阡?
relay_url = http://192.168.1.100/relay/trigger  # 蝜潮??API
```

## 嚙?雿輻??

### ?? Web 隞?

#### 1. 擐? - ?單???
- ????敶望??單??恍
- ???菜葫蝯梯?嚗???/???
- ??蝟餌絞????
- ??蝜潮?冽?嗆葫閰?

#### 2. ? ?蔣蝞∠?
- ??敶梁??ˊ??甇?
- ???蔣?”????
- ??敶梁?頧? (XVID/MJPG/H264)
- ???瑕?閮毀敶望
- ???寞活?芷蝞∠?

#### 3. ?儭?鞈?璅酉
- ??LabelImg 憸冽璅酉隞
- ??AI ?芸?璅酉 (YOLOv8)
- ???寞活???祟??
- ???????菜葫
- ??蝛箇??瑼Ｘ葫
- ??璆萇垢璅?獢?瞈?
- ??璅酉鞈??臬

#### 4. ?? 璅∪?閮毀
- ??YOLOv8 閮毀隞
- ???單?閮毀?脣漲
- ??閮毀?脩?憿舐內
- ??GPU 雿輻???
- ??璅∪?閰摯?葫閰?

### ?? 撌乩?瘚?

```mermaid
graph LR
    A[?蔣] --> B[?瑕?敶望]
    B --> C[鞈?璅酉]
    C --> D[?臬鞈??
    D --> E[璅∪?閮毀]
    E --> F[璅∪?閰摯]
    F --> G[?函蔡?菜葫]
    G --> A
```

1. **?蔣** ???典祕撽恕/撌亙??ˊ蝟?敶梁?
2. **?瑕?敶望** ??敺蔣?葉?瑕?閮毀?函?敶勗?
3. **鞈?璅酉** ????璅酉??AI 頛璅酉
4. **?臬鞈???* ??頧???YOLO 閮毀?澆?
5. **璅∪?閮毀** ??YOLOv8 閮毀?唳芋??
6. **璅∪?閰摯** ??皜祈岫璅∪??扯
7. **?函蔡?菜葫** ??雿輻?唳芋?脰??單??菜葫

## 嚙?API ??

### 璅∪?蝞∠?
- `GET /api/models` - ????冽芋??
- `GET /api/models/current` - ???桀?雿輻?芋??
- `POST /api/models/change` - ??璅∪?

### 閮毀蝞∠?
- `POST /api/training/start` - ??閮毀
- `GET /api/training/status` - ??閮毀???
- `POST /api/training/stop` - ?迫閮毀
- `GET /api/training/models` - ?撌脰?蝺渡?璅∪?

### 鞈?蝞∠?
- `POST /api/annotate/export` - ?臬璅酉鞈???
- `POST /api/annotate/extract_frames` - 敺蔣??蔣??
- `POST /api/annotate/detect_duplicates` - ?菜葫????
- `POST /api/annotate/auto_label` - AI ?芸?璅酉

### 蝯梯??風??
- `GET /api/stats` - ?單?蝯梯?
- `GET /api/history` - 甇瑕蝝?閰?
- `GET /api/history/export` - ?臬 CSV

## ??儭??銵瑽?

### ?詨??銵?
- **瘛勗漲摮貊?**: YOLOv8 (Ultralytics) / YOLOv4-tiny (Darknet)
- **敶勗???**: OpenCV 4.x
- **Web 獢**: Flask 3.x
- **鞈?摨?*: SQLite 3
- **?垢**: Vanilla JavaScript + Axios

### 蝟餌絞?嗆?

```
????????????????????????????????????????????????
??             Web Browser (Port 5000)        ??
??    擐? ???蔣 ??璅酉 ??閮毀                ??
????????????????????砂????????????????????????????
                   ??HTTP/WebSocket
????????????????????潑????????????????????????????
??           Flask Web Server                  ??
?? ??????????????砂?????????????砂??????????????????
?? ??Detection  ??Recorder   ??Trainer      ????
?? ??Manager    ??Manager    ??Manager      ????
?? ??????????????氯?????????????氯??????????????????
????????????????????砂????????????????????????????
                   ??
????????????????????潑????????????????????????????
??        YOLOv8 / OpenCV Layer               ??
?? ?????????????????????????????????????????????
?? ?? Model Inference ??Video Capture       ????
?? ?? Image Processing??Recording           ????
?? ?????????????????????????????????????????????
????????????????????砂????????????????????????????
                   ??
????????????????????潑????????????????????????????
??    Hardware (Camera, GPU, Relay)           ??
????????????????????????????????????????????????
```

## ?? ???

### ?啣??蔣璈?

??`config.ini` 憓??啁??蔣璈?憛?

```ini
[Camera3]
index = 2
width = 1920
height = 1080
relay_url = http://192.168.1.103/relay/trigger
relay_delay_ms = 100
```

### ?芾?憿

蝺刻摩 `models/classes.txt`嚗?

```txt
good
defect_crack
defect_spot
defect_broken
```

### ?游??

?詨?璅∠??賢 `src/` ??`candy_detector/` ?桅?嚗?

- ?啣??菜葫?摩 ??`src/run_detector.py`
- ?啣? API 蝡舫? ??`src/web_app.py`
- 靽格閮毀瘚? ??`src/yolov8_trainer.py`

## ?? ?賊???

閰喟敦??隢???[`docs/`](docs/) 鞈?憭橘?

- ?? [BAT ?單??](docs/BAT_SCRIPTS_GUIDE.md)
- ? [閬?蝺函Ⅳ?豢?](docs/video_codec_selector.md)
- ? [?函蔡??](docs/deployment/)
- ??[??芸?](docs/optimization/)

## ?? 瘜冽?鈭?

1. **璅∪?瑼?**: `.pt` / `.weights` 瑼??芸??怠?摨思葉嚗?獢?憭改?嚗??芾?閮毀??頛?
2. **鞈???*: `datasets/` ?桅?撌脣???`.gitignore`嚗????喳 Git
3. **GPU ?舀**: ?閬?鋆?CUDA ??cuDNN嚗yTorch ??皜?
4. **?蔣璈???*: Linux 蝟餌絞?航?閬?雿輻????`video` 蝢斤?
## ?? 鞎Ｙ??

甇∟??漱 Issue ??Pull Request嚗?

### ?瘚?

1. Fork ?砍?獢?
2. 撱箇??函??? (`git checkout -b feature/AmazingFeature`)
3. ?漱?函?霈 (`git commit -m 'Add some AmazingFeature'`)
4. ?券? (`git push origin feature/AmazingFeature`)
5. ?? Pull Request

### 蝔?蝣潮◢??

- Python: ?萄儐 PEP 8
- JavaScript: 雿輻 ESLint 撱箄降?蔭
- 閮餉圾: ???賢?隢?銝?docstring

## ?? ??

?砍?獢??MIT ??璇狡 - 閰唾? [LICENSE](LICENSE) 瑼?

## ? 雿?

- **Lei-TzuY** - [GitHub](https://github.com/Lei-TzuY)

## ?? ?渲?

- [Ultralytics YOLOv8](https://github.com/ultralytics/ultralytics) - YOLO 璅∪?獢
- [OpenCV](https://opencv.org/) - 敶勗????賢?摨?
- [Flask](https://flask.palletsprojects.com/) - Web 獢
- [LabelImg](https://github.com/heartexlabs/labelImg) - 璅酉撌亙??

## ?? ?舐窗?孵?

憒????遣霅堆?甇∟???隞乩??孵??舐窗嚗?

- ? Email: your-email@example.com
- ? GitHub Issues: [???](https://github.com/Lei-TzuY/candy-defect-detection/issues)

---

<p align="center">
  <strong>Made with ?歹? for intelligent candy quality control</strong>
</p>

<p align="center">
  潃?憒???獢??冽?撟怠嚗?蝯虫?憿??? 潃?
</p>
